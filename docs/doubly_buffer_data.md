# Doubly Buffer Data

## 背景

Doubly Buffer Data(DBD)是一种高效的读多写少的数据结构，它基于thread-local锁实现前台数据与后台数据切换，用于RPC框架中`NameService`存储节点列表与`LALB`存储节点列表。

## 实现
- 数据分前台与后台
- 读时获取一把thread-local锁，在读完数据后释放锁
- 写操作之间互斥，写时先修改后台数据，随后原子地切换前台与后台数据，然后逐个获取所有thread-local锁后立即释放锁，随后修改老前台（新后台）

我们来分析下这个方法的基本原理：

- 当一个读正在发生时，它会拿着所在线程的thread-local锁，这把锁会挡住同时进行的写，从而保证前台数据不会被修改。
- 在大部分时候thread-local锁都没有竞争，对性能影响很小。
- 逐个获取thread-local锁并立刻释放是为了**确保对应的读线程看到了切换后的新前台**。如果所有的读线程都看到了新前台，写线程便可以安全地修改老前台（新后台）了。